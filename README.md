# LLM 기반 타겟 모델 최적화 데이터 전처리 (Jupyter Notebook)

## 개요

이 문서는 금융 Q&A 데이터를 로드하여 대규모 언어 모델(LLM, 여기서는 GPT-4o)을 사용해 전처리하는 **Jupyter Notebook (`.ipynb`)** 버전에 대한 안내입니다. 노트북은 최종적으로 사용할 모델의 유형(`RAG` 또는 `Fine-tuning`)에 따라 최적화된 전처리 작업을 단계별로 실행하고 결과를 확인할 수 있도록 구성되어 있습니다.

-   **RAG (Retrieval-Augmented Generation) 최적화:** 검색 시스템에서 효과적으로 사용될 수 있도록 답변 내용을 재구성하고, 관련 개체명을 추출합니다.
-   **Fine-tuning 최적화:** 모델 학습 데이터의 품질과 다양성을 높이기 위해 질문 변형을 생성하고, 답변 스타일을 일관되게 표준화합니다.

## 주요 기능

-   Hugging Face Hub에서 금융 Q&A 데이터셋 로드 (`aiqwe/FinShibainu` 기본값).
-   LLM을 이용한 답변 품질 평가 (1~5점).
-   **RAG 최적화:**
    -   답변을 명확하고 간결하게 재작성 (`rewrite_for_rag_context`).
    -   답변에서 주요 개체명 및 금융 용어 추출 (`extract_entities_for_rag`).
-   **Fine-tuning 최적화:**
    -   원본 질문과 의미는 같지만 표현이 다른 질문 생성 (`generate_multiple_question_variations`).
    -   답변 스타일을 지정된 목표 스타일에 맞게 표준화 (`standardize_answer_style`).
-   처리 목표 모델 유형(`RAG` 또는 `Fine-tuning`)에 따른 조건부 전처리 실행.
-   처리된 데이터를 CSV 파일로 저장.
-   Google Colab 환경 감지 및 지원 (API 키 로딩 등).
-   단계별 코드 실행 및 중간 결과 확인이 용이한 노트북 인터페이스.

## 요구사항

-   Python 3.x
-   **Jupyter Notebook 환경:** Jupyter Lab, Jupyter Notebook, Google Colab, VS Code 등 `.ipynb` 파일을 실행할 수 있는 환경.
-   **필수 라이브러리:** 노트북 내 첫 번째 코드 셀 또는 터미널에서 설치합니다.
    ```bash
    pip install pandas langchain-openai langchain-core datasets tqdm google-colab # Colab 사용 시
    # 또는 로컬 환경 등
    pip install pandas langchain-openai langchain-core datasets tqdm python-dotenv # dotenv 사용 시
    ```
-   **OpenAI API 키:** LLM 호출을 위해 유효한 OpenAI API 키가 필요합니다. 노트북 내 지정된 셀에서 설정해야 합니다.

## 설정

노트북 실행 전, **반드시** 다음 설정을 확인하고 필요한 값을 입력해야 합니다.

1.  **API 키 설정:** 노트북 상단의 **`1. 설정 및 API 키 구성`** 코드 셀을 찾습니다.
    *   **`YOUR_OPENAI_API_KEY` Placeholder:** 해당 셀 내에서 `api_key = os.getenv('OPENAI_API_KEY', 'YOUR_OPENAI_API_KEY')` 라인 또는 유사한 부분을 찾아 `'YOUR_OPENAI_API_KEY'`를 **본인의 실제 OpenAI API 키 문자열**로 직접 교체하거나, 해당 환경 변수(`OPENAI_API_KEY`)를 설정합니다.
    *   **Google Colab:** Colab 환경을 사용하는 경우, Colab의 'Secrets' 탭에 `OPENAI_API_KEY`라는 이름으로 키를 저장하면 코드가 자동으로 인식합니다. (별도 수정 불필요)
    *   **API 키 미설정 시 LLM 초기화 및 이후 단계가 실패합니다.**

2.  **실행 설정:** 동일한 **`1. 설정 및 API 키 구성`** 셀 내에서 다음 변수들을 필요에 따라 수정합니다.
    *   `TARGET_MODEL`: 전처리 목표를 설정합니다. `"RAG"` 또는 `"Fine-tuning"` 중 하나를 선택합니다. (기본값: `"Fine-tuning"`)
    *   `DATA_SPLIT`: 처리할 데이터의 양을 지정합니다. Hugging Face `datasets` 라이브러리의 슬라이싱 문법을 사용합니다 (예: `'train[:10]'`는 학습 데이터의 첫 10개를 의미). (기본값: `'train[:10]'`)
    *   `OUTPUT_FILENAME_BASE`: 저장될 CSV 파일의 기본 이름을 설정합니다. 최종 파일명은 `{OUTPUT_FILENAME_BASE}_{TARGET_MODEL}.csv` 형식이 됩니다. (기본값: `"finance_data_preprocessed"`)
    *   `ft_target_style` (Fine-tuning 시): 답변 스타일 표준화 시 목표 스타일을 정의하는 문자열입니다. (기본값 제공)
    *   `ft_num_variations` (Fine-tuning 시): 생성할 질문 변형의 개수입니다. (기본값: `3`)

## 사용법

1.  **노트북 열기:** 선호하는 Jupyter 환경에서 `.ipynb` 파일을 엽니다.
2.  **설정 및 API 키 입력:** 위 **'설정'** 섹션의 안내에 따라 **`1. 설정 및 API 키 구성`** 셀에서 API 키와 실행 설정을 완료합니다.
3.  **셀 순차적 실행:** 노트북의 첫 번째 셀부터 마지막 셀까지 순서대로 실행합니다. 일반적으로 셀을 선택하고 `Shift + Enter` 키를 누릅니다.
4.  **출력 확인:** 각 코드 셀 실행 후 출력되는 로그 메시지, 데이터 로딩 상태, 전처리 진행률, 최종 DataFrame 미리보기 (`display(...)` 결과) 등을 확인합니다.
5.  **결과 파일 확인:** 모든 셀 실행이 성공적으로 완료되면, 노트북 파일이 위치한 디렉토리에 설정된 파일명(예: `finance_data_preprocessed_fine-tuning.csv`)으로 전처리된 데이터가 CSV 파일로 저장됩니다.

## 전처리 상세 내용

(이 섹션은 스크립트 버전과 동일합니다. 전처리 로직 자체는 변경되지 않았습니다.)

### 공통

-   **품질 점수 (`llm_quality_score`):** LLM이 질문과 답변 쌍을 평가하여 1점에서 5점 사이의 점수를 부여합니다. 답변의 명확성, 정확성, 완결성을 기준으로 합니다.

### RAG 타겟 (`TARGET_MODEL = "RAG"`)

-   **RAG 답변 재작성 (`rag_answer_context`):** 원본 답변(`answer_B` 또는 `answer_A`)을 RAG 시스템의 검색 결과(컨텍스트)로 사용하기 좋도록 명확하고 정보 중심으로 재작성합니다.
-   **RAG 개체명/키워드 추출 (`rag_entities`):** 재작성된 답변 (또는 원본 답변)에서 중요한 금융 관련 개체명이나 핵심 용어를 추출하여 쉼표로 구분된 문자열로 만듭니다.

### Fine-tuning 타겟 (`TARGET_MODEL = "Fine-tuning"`)

-   **질문 변형 생성 (`ft_question_variations`):** 원본 질문과 동일한 의미를 가지지만 다른 어투나 단어를 사용한 여러 버전의 질문을 생성하여 리스트로 저장합니다.
-   **답변 스타일 표준화 (`ft_standardized_answer`):** 원본 답변(`answer_B` 또는 `answer_A`)의 핵심 내용은 유지하면서, 미리 정의된 `ft_target_style`에 맞게 문체를 변환합니다.

## 출력

-   **노트북 내 출력:** 코드 셀 실행 시 로그 메시지, 데이터프레임 미리보기 등이 셀 바로 아래에 표시됩니다.
-   **CSV 파일:** 최종적으로 전처리된 모든 데이터를 포함하는 CSV 파일이 생성됩니다. 파일에는 원본 데이터 컬럼과 함께 아래의 새로운 컬럼들이 포함됩니다.
    -   **공통 추가 컬럼:** `llm_quality_score`
    -   **RAG 결과 추가 컬럼:** `rag_answer_context`, `rag_entities`
    -   **Fine-tuning 결과 추가 컬럼:** `ft_question_variations`, `ft_standardized_answer`

**(주의)** 아래 예시는 출력 형식과 추가되는 컬럼을 보여주기 위한 것이며, 실제 내용은 LLM의 응답에 따라 달라집니다.

### 예상 결과 예시 (`TARGET_MODEL = "RAG"`)

| question                  | answer\_B (Original)                                  | llm\_quality\_score | rag\_answer\_context                                                                 | rag\_entities                 |
| :------------------------ | :---------------------------------------------------- | :------------------ | :----------------------------------------------------------------------------------- | :---------------------------- |
| 주식과 ETF의 차이는 뭔가요? | 주식은 개별 회사 소유권이고, ETF는 여러 자산을 묶은 펀드입니다. ETF가 분산투자에 유리합니다. | 4                   | 주식은 단일 기업의 지분을 나타내며, ETF(상장지수펀드)는 주식, 채권 등 다양한 자산을 포함하는 펀드로 분산투자 효과가 있습니다. | 주식, ETF, 상장지수펀드, 분산투자 |
| 금리 인상 시 대처 방법은? | 금리가 오르면 대출 이자 부담이 커지니, 변동금리 대출을 고정금리로 바꾸거나 원금을 상환하는 것이 좋습니다. | 5                   | 금리 상승기에는 대출 이자 부담 증가에 대비해야 합니다. 변동금리 대출을 고정금리로 전환하거나, 부채 상환을 고려하는 것이 주요 대응 방안입니다. | 금리, 대출, 이자, 변동금리, 고정금리 |

### 예상 결과 예시 (`TARGET_MODEL = "Fine-tuning"`)

| question                  | answer\_B (Original)                                  | llm\_quality\_score | ft\_question\_variations                                                                                                                               | ft\_standardized\_answer                                                                                                 |
| :------------------------ | :---------------------------------------------------- | :------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------- |
| 주식과 ETF의 차이는 뭔가요? | 주식은 개별 회사 소유권이고, ETF는 여러 자산을 묶은 펀드입니다. ETF가 분산투자에 유리합니다. | 4                   | `['주식과 ETF 뭐가 달라요?', 'ETF랑 주식의 개념 차이가 궁금해요.', '주식이랑 ETF 정의 좀 알려주세요.']`                                                                 | 주식은 특정 기업에 대한 소유권을 나타내는 증권이며, ETF(상장지수펀드)는 다양한 기초자산으로 구성된 포트폴리오를 추종하는 펀드입니다. 일반적으로 ETF는 분산투자 측면에서 장점을 가집니다. |
| 금리 인상 시 대처 방법은? | 금리가 오르면 대출 이자 부담이 커지니, 변동금리 대출을 고정금리로 바꾸거나 원금을 상환하는 것이 좋습니다. | 5                   | `['금리 오를 때 어떻게 해야 하나요?', '이자율 상승기에 재정 관리법 알려주세요.', '금리가 인상될 경우 개인은 뭘 준비해야 할까요?']` | 금리 인상 시기에는 이자율 변동 위험 관리가 중요합니다. 변동금리 대출 보유 시 고정금리 전환을 검토하거나, 가용 자금을 활용한 원금 상환을 통해 이자 부담을 경감하는 전략을 고려할 수 있습니다. |

## 주의사항

-   **API 비용 및 속도:** LLM API 호출은 비용이 발생하며, 데이터 양(`DATA_SPLIT` 설정)과 API 응답 속도에 따라 처리 시간이 오래 걸릴 수 있습니다. 노트북 내 `time.sleep()`은 API 속도 제한(Rate Limit)을 피하기 위한 조치입니다.
-   **입력 데이터 형식:** 노트북은 입력 DataFrame에 `question`, `answer_A`, `answer_B` 컬럼이 존재한다고 가정합니다. 해당 컬럼이 없으면 빈 값으로 채워지나, 전처리 결과 품질에 영향을 줄 수 있습니다.
-   **LLM 의존성:** 전처리 결과의 품질은 사용된 LLM 모델(기본값: `gpt-4o`)의 성능과 프롬프트 설계에 따라 달라질 수 있습니다. 프롬프트는 노트북 내 함수 정의 셀에서 확인 및 수정 가능합니다.
-   **오류 처리:** API 키 오류, 네트워크 문제 등으로 특정 셀 실행이 실패할 수 있습니다. 오류 메시지를 확인하고 문제를 해결한 후 해당 셀부터 다시 실행하세요.
