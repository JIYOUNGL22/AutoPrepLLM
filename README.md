# LLM 기반 목표 모델 최적화 금융 데이터셋 자동 전처리 (Standalone)

## 1. 개요

이 스크립트는 Hugging Face의 `aiqwe/FinShibainu` 금융 Q&A 데이터셋에 대해 LLM(GPT-4o)을 활용하여 자동 전처리 작업을 수행하는 **독립 실행형 Python 스크립트**입니다. 핵심 목표는 후속 작업으로 사용할 **다운스트림 모델(RAG 또는 Fine-tuning)의 특성에 맞춰 데이터셋을 최적화**하는 것입니다. LLM의 자연어 이해 및 생성 능력을 활용하여 데이터 품질 평가, 텍스트 정제/개선, 키워드 추출, 데이터 증강 등의 작업을 자동화합니다.

## 2. 주요 기능

*   `aiqwe/FinShibainu` 데이터셋 로딩 (Hugging Face Datasets 라이브러리 사용)
*   **목표 모델 타입 선택:** RAG 또는 Fine-tuning 모델 중 어떤 모델에 최적화할지 선택 가능
*   **LLM(GPT-4o) 기반 전처리:**
    *   (공통) 답변 품질 자동 평가 (1~5점)
    *   **(RAG 최적화)** 검색 컨텍스트에 적합하도록 답변 재작성
    *   **(RAG 최적화)** 답변에서 주요 개체명/금융 용어 추출
    *   **(Fine-tuning 최적화)** 다양한 표현의 질문 변형 생성 (데이터 증강)
    *   **(Fine-tuning 최적화)** 일관된 스타일로 답변 표준화
*   전처리 결과(새로운 컬럼)를 원본 데이터에 추가
*   처리된 데이터프레임을 CSV 파일로 저장

## 3. 동작 방식

스크립트는 사용자가 설정한 `TARGET_MODEL` 값("RAG" 또는 "Fine-tuning")에 따라 다른 전처리 파이프라인을 실행합니다. 각 파이프라인은 LangChain 프레임워크를 사용하여 정의된 프롬프트와 LLM(GPT-4o)을 호출하여 해당 목표 모델에 유용한 정보를 생성하거나 데이터를 변환합니다.

*   **기술 스택:** Python, Pandas, LangChain, OpenAI API, Hugging Face Datasets, tqdm

## 4. 설치

스크립트를 실행하기 전에 다음 라이브러리들을 설치해야 합니다.

```bash
pip install pandas datasets langchain langchain-openai langchain-core tqdm openai python-dotenv

## 5. 설정

### 5.1. OpenAI API 키 설정

스크립트 실행 환경에 OpenAI API 키를 설정해야 합니다.

*   **환경 변수 사용 (권장):**
    터미널에서 다음 명령어를 실행하거나 시스템 환경 변수를 설정합니다.
    ```bash
    export OPENAI_API_KEY='your_openai_api_key'
    ```
    또는 스크립트와 같은 디렉토리에 `.env` 파일을 만들고 다음 내용을 추가합니다:
    ```dotenv
    OPENAI_API_KEY='your_openai_api_key'
    ```
    *(참고: `.env` 파일을 사용하려면 스크립트 내에서 `python-dotenv` 라이브러리를 사용하여 로드하는 코드가 필요할 수 있습니다. 현재 제공된 스크립트에는 이 로직이 기본 포함되어 있지 않습니다.)*

*   **Google Colab 사용:**
    Colab의 'Secrets' 기능(좌측 메뉴의 키 모양 아이콘)을 사용하여 `OPENAI_API_KEY`라는 이름으로 API 키 값을 저장합니다. 스크립트가 실행될 때 자동으로 이 값을 감지하여 사용합니다.

## 6. 사용 방법

1.  스크립트 파일 (`llm_auto_preprocess_targeted_standalone.py`)을 준비합니다.
2.  스크립트 내 **`=== 6. 메인 실행 블록 ===`** 아래의 **`--- 사용자 설정 영역 ---`** 부분을 필요에 맞게 수정합니다.
    *   `TARGET_MODEL`: 전처리 목표 모델 타입을 `"RAG"` 또는 `"Fine-tuning"` 중 하나로 설정합니다. **(필수)**
    *   `DATA_SPLIT`: 처리할 데이터의 범위나 양을 지정합니다. (예: `'train[:50]'`는 학습 데이터의 첫 50개 샘플, `'train'`은 전체 학습 데이터). **API 비용 및 처리 시간을 고려하여 테스트 시에는 작은 값(예: `'train[:10]'`)으로 설정하는 것을 강력히 권장합니다.**
    *   `OUTPUT_FILENAME_BASE`: 저장될 결과 CSV 파일의 기본 이름을 설정합니다. 최종 파일명은 `{OUTPUT_FILENAME_BASE}_{target_model}.csv` 형식으로 생성됩니다. (예: `finance_data_preprocessed_rag.csv`)
    *   `SLEEP_BETWEEN_ROWS`: 각 데이터 행 처리 후 대기할 시간(초)을 설정합니다. OpenAI API의 분당 요청 수 제한(Rate Limit) 오류를 피하기 위해 사용됩니다. 네트워크 상태나 API 플랜에 따라 적절히 조절합니다. (0은 대기 없음)
    *   **(선택 사항 - Fine-tuning 모드 시):** `preprocess_data_with_llm_targeted` 함수 호출 시 `ft_target_style` (답변 스타일 설명) 또는 `ft_num_variations` (질문 변형 개수) 인자를 직접 전달하여 기본값을 변경할 수 있습니다.
3.  설정이 완료되면 터미널에서 다음 명령어를 사용하여 스크립트를 실행합니다.
    ```bash
    python llm_auto_preprocess_targeted_standalone.py
    ```

## 7. 전처리 단계 상세 설명

스크립트는 `TARGET_MODEL` 설정에 따라 다음과 같은 새로운 컬럼을 생성하여 기존 데이터프레임에 추가합니다.

### 7.1. `TARGET_MODEL = "RAG"` 선택 시

RAG(검색 증강 생성) 모델 최적화를 위해 다음과 같은 컬럼이 생성됩니다.

*   **`rag_answer_context` 컬럼:**
    *   **목적:** 원본 답변(`answer_B` 우선 사용)을 RAG 시스템의 검색 결과(컨텍스트)로 사용하기 좋게 LLM이 재작성합니다. 검색된 조각만으로도 LLM이 답변을 생성하는 데 필요한 정보를 명확하고 간결하게 제공하는 것을 목표로 합니다. (`rewrite_for_rag_context` 함수 사용)
*   **`rag_entities` 컬럼:**
    *   **목적:** 재작성된 답변 또는 원본 답변에서 주요 금융 개체명(예: 회사, 상품, 법규)이나 핵심 용어(예: 금리, 인플레이션)를 LLM이 추출합니다. 이 정보는 RAG 시스템에서 메타데이터 필터링, 검색 쿼리 확장 등에 활용될 수 있습니다. (`extract_entities_for_rag` 함수 사용)
*   **`llm_quality_score` 컬럼:**
    *   **목적:** 재작성된 답변(`rag_answer_context`) 또는 원본 답변의 품질을 LLM이 1점부터 5점까지 평가합니다. 이 점수는 RAG 시스템의 벡터 데이터베이스에 저장할 컨텍스트를 선별하거나, 품질이 낮은 컨텐츠를 개선하는 데 사용될 수 있습니다. (`get_quality_score` 함수 사용)

### 7.2. `TARGET_MODEL = "Fine-tuning"` 선택 시

Fine-tuning 모델 학습 데이터 품질 향상을 위해 다음과 같은 컬럼이 생성됩니다.

*   **`llm_quality_score` 컬럼:**
    *   **목적:** 원본 답변(`answer_B` 우선 사용)의 품질을 LLM이 1점부터 5점까지 평가합니다. 이 점수를 기준으로 품질이 좋은 질문-답변 쌍만 선별하여 Fine-tuning 데이터셋을 구성하는 데 사용할 수 있습니다. (`get_quality_score` 함수 사용)
*   **`ft_question_variations` 컬럼:**
    *   **목적:** 원본 질문과 핵심 의미는 동일하지만, 표현 방식(어휘, 문체, 구조 등)이 다른 여러 질문(기본 3개)을 LLM이 생성합니다. 모델이 다양한 형태의 사용자 질문에 더 강건하게 대응하도록 학습시키는 데이터 증강(Data Augmentation) 효과를 얻기 위함입니다. (`generate_multiple_question_variations` 함수 사용)
*   **`ft_standardized_answer` 컬럼:**
    *   **목적:** 원본 답변(`answer_B` 우선 사용)을 미리 정의된 일관된 목표 스타일(기본값: "명확하고 간결하며 중립적인 전문가 톤으로 작성")로 LLM이 재작성합니다. Fine-tuning된 모델이 일관된 톤앤매너(Tone and Manner)로 답변을 생성하도록 유도하는 데 사용됩니다. (`standardize_answer_style` 함수 사용)

## 8. 예상 결과

*(아래 예시는 `DATA_SPLIT='train[:3]'`으로 3개 샘플만 처리했을 경우를 가정합니다. LLM 응답은 비결정적일 수 있으므로 실제 결과는 실행 시마다 약간 다를 수 있습니다.)*

### 8.1. 콘솔 출력 예시

```text
==================================================
 LLM 기반 타겟 모델 최적화 자동 전처리 스크립트
==================================================
OpenAI API 키 설정 완료.
LLM 초기화 완료 (모델: gpt-4o)
LLM 기반 타겟 모델 최적화 자동 전처리 스크립트 시작...
데이터셋 로딩 시작: 'aiqwe/FinShibainu' (설정: qa, 범위: train[:3])...
데이터셋 로드 성공. 총 3개의 샘플 확보.
총 3개 행에 대해 'Fine-tuning' 목표 LLM 전처리를 시작합니다... # 예시: Fine-tuning 모드
--- Fine-tuning 최적화 전처리 단계 ---
1/3: Fine-tuning 품질 점수 평가 중...
Fine-tuning 전처리 진행률: 100%|██████████| 3/3 [00:04<00:00,  1.5s/it] # 예시 시간
2/3: Fine-tuning 질문 변형 생성 중...
Fine-tuning 전처리 진행률: 100%|██████████| 3/3 [00:08<00:00,  2.7s/it] # 예시 시간
3/3: Fine-tuning 답변 스타일 표준화 중...
Fine-tuning 전처리 진행률: 100%|██████████| 3/3 [00:06<00:00,  2.0s/it] # 예시 시간
LLM 기반 전처리 작업이 완료되었습니다.

--- 전처리 결과 미리보기 (상위 5개 행) ---
| question                                               | answer_B                                                                     |   llm_quality_score | ft_question_variations                                                                  | ft_standardized_answer                                                                                                                                    |
|:-------------------------------------------------------|:-----------------------------------------------------------------------------|--------------------:|:----------------------------------------------------------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------|
| 가계부문의 순저축률을 측정하는 공식을 적고, 각 항목이 의미하는 바를 설명하시오. | answer B는 공식과 각 항목의 의미를 명확히 설명하고 있으며, 순저축률의 중요성까지 다루... |                   4 | ['가계 순저축률 계산식 알려줘', '가계 순저축률 공식과 각 부분의 의미는?', '순저축률 어떻게 구해요?']        | 가계부문 순저축률은 가계의 순처분가능소득 대비 순저축액의 비율을 나타냅니다. 계산식은 (가계부문 순저축액) / (가계 순처분가능소득 + 사회적 현물이전 수취 + 연금기금 조정액) 이며, 각 항목은... |
| 로보어드바이저가 가지고 있는 장점은 무엇이며, 특히 소액 자산가에게 어떤 이점... | 로보어드바이저는 낮은 수수료로 전문적인 포트폴리오 관리를 받을 수 있다는 장점이 있으며... |                   5 | ['로보어드바이저 쓰면 뭐가 좋아요?', '소액 투자자에게 로보어드바이저 추천하는 이유좀', '로보어드바이저의 강점 설명'] | 로보어드바이저는 자동화된 알고리즘을 통해 저렴한 비용으로 개인 맞춤형 투자 포트폴리오 관리 서비스를 제공합니다. 특히 낮은 최소 투자 금액으로 소액 투자자의 접근성을 높였으며, 데이터 기반의 객관적인 투자를 지원합니다. |
| 로보어드바이저의 의미와 서비스가 제공되는 방식은 무엇인가요?                 | 로보어드바이저(Robo-Advisor)는 인공지능(AI) 및 알고리즘을 기반으로 투자 자산 관리... |                   5 | ['로보어드바이저가 뭐에요?', '로보어드바이저 서비스는 어떻게 이용하나요?', '로보어드바이저 개념과 작동 방식'] | 로보어드바이저는 인공지능(AI)과 알고리즘을 활용하여 온라인으로 투자 자문 및 자산 관리 서비스를 제공하는 자동화된 디지털 플랫폼입니다. 서비스 이용 방식은 일반적으로 사용자 정보 입력, 투자 성향 분석, 맞춤 포트폴리오 제안, 지속적인 관리 및 리밸런싱 순으로 진행됩니다. |

[성공] 전처리된 데이터가 'finance_data_preprocessed_fine-tuning.csv'(으)로 저장되었습니다.

총 실행 시간: 20.75 초
==================================================
 스크립트 실행 완료
==================================================

### 8.2. 생성되는 CSV 파일 내용 예시

*(참고: LLM 생성 결과는 실행 시마다 약간의 변동이 있을 수 있습니다.)*

#### 8.2.1. `finance_data_preprocessed_rag.csv` (RAG 모드 시)

| question                                                         | rag_answer_context                                                                                                                               | rag_entities                                                                 | llm_quality_score | ... (원본 컬럼들) ... |
| :--------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------- | :---------------- | :-------------------- |
| 가계부문의 순저축률을 측정하는 공식을 적고, 각 항목이 의미하는 바를 설명하시오. | 가계부문 순저축률은 (가계 순저축액) / (가계 순처분가능소득 + 사회적 현물이전 수취 + 연금기금 조정액)으로 계산됩니다. 이는 가계 저축 성향과 경제 안정성을 나타내는 지표입니다. | 가계부문 순저축률, 순저축액, 순처분가능소득, 사회적 현물이전, 연금기금, 경제 지표 | 4                 | ...                   |
| 로보어드바이저가 가지고 있는 장점은 무엇이며, 특히 소액 자산가에게 어떤 이점...   | 로보어드바이저는 AI 기반 온라인 투자 관리 서비스로, 저렴한 수수료, 자동 포트폴리오 관리, 데이터 기반 의사결정이 장점입니다. 특히 소액 자산가도 쉽게 접근 가능합니다.    | 로보어드바이저, AI, 알고리즘, 자산 관리, 소액 투자자, 수수료, 자동화, 데이터 | 5                 | ...                   |
| 로보어드바이저의 의미와 서비스가 제공되는 방식은 무엇인가요?                   | 로보어드바이저는 AI/알고리즘을 이용한 맞춤형 투자 조언 및 자산 배분 플랫폼입니다. 사용자 리스크 프로파일링 후 포트폴리오를 구성하고 자동으로 조정합니다.               | 로보어드바이저, 인공지능, AI, 알고리즘, 투자 조언, 자산 배분, 리스크 프로파일링 | 5                 | ...                   |

#### 8.2.2. `finance_data_preprocessed_fine-tuning.csv` (Fine-tuning 모드 시)

| question                                                         | answer_B                                                                 | llm_quality_score | ft_question_variations                                                          | ft_standardized_answer                                                                                                                                    | ... (원본 컬럼들) ... |
| :--------------------------------------------------------------- | :----------------------------------------------------------------------- | :---------------- | :------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------- |
| 가계부문의 순저축률을 측정하는 공식을 적고, 각 항목이 의미하는 바를 설명하시오. | answer B는 공식과 각 항목의 의미를 명확히 설명하고 있으며, 순저축률의 중요성까지 다루... | 4                 | `['가계 순저축률 공식과 각 항목 설명해줘', '가계 순저축률 계산식 알려주세요', '순저축률 측정 방법은?']` | 가계부문 순저축률은 (가계부문 순저축액) / (가계 순처분가능소득 + 사회적 현물이전 수취 + 연금기금 조정액)으로 계산됩니다. 이는 가계의 저축 능력을 나타내는 주요 지표입니다. | ...                   |
| 로보어드바이저가 가지고 있는 장점은 무엇이며, 특히 소액 자산가에게 어떤 이점...   | 로보어드바이저는 낮은 수수료로 전문적인 포트폴리오 관리를 받을 수 있다는 장점이 있으며... | 5                 | `['로보어드바이저 좋은 점?', '소액투자자에게 로보어드바이저가 왜 유리한가요?', '로보어드바이저 이점 정리']` | 로보어드바이저는 자동화된 알고리즘을 통해 저렴한 비용으로 맞춤형 자산 관리 서비스를 제공합니다. 낮은 최소 투자 금액으로 소액 자산가도 접근성이 높으며, 감정에 치우치지 않는 데이터 기반 투자가 가능합니다. | ...                   |
| 로보어드바이저의 의미와 서비스가 제공되는 방식은 무엇인가요?                   | 로보어드바이저(Robo-Advisor)는 인공지능(AI) 및 알고리즘을 기반으로 투자 자산 관리... | 5                 | `['로보어드바이저란 무엇인가?', '로보어드바이저 서비스는 어떻게 동작하나요?', '로보어드바이저 개념 설명']` | 로보어드바이저는 인공지능(AI)과 알고리즘을 활용하여 사용자에게 맞춤형 투자 자문 및 자산 배분 서비스를 제공하는 디지털 플랫폼입니다. 서비스는 사용자 정보 입력, 리스크 성향 분석, 포트폴리오 제안, 자동 리밸런싱 순으로 진행됩니다. | ...                   |

*(참고: `ft_question_variations` 컬럼은 CSV 저장 시 Python 리스트 객체가 위 예시처럼 문자열 형태로 저장될 수 있습니다. 데이터를 로드한 후에는 `ast.literal_eval` 등을 사용하여 다시 리스트 객체로 변환해야 할 수 있습니다.)*
